"""expand marketplace content

Revision ID: g4h5i6j7k8l9
Revises: f3g4h5i6j7k8
Create Date: 2026-02-14 23:00:00.000000

"""
import json
import uuid
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

revision: str = "g4h5i6j7k8l9"
down_revision: Union[str, None] = "f3g4h5i6j7k8"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def _id():
    return str(uuid.uuid4())


def _cmd(slug, name, icon, category, prompt, requires_file, sort, description):
    return {
        "id": _id(), "item_type": "command", "slug": slug, "name": name,
        "icon": icon, "category": category, "is_builtin": True, "is_featured": not requires_file,
        "install_count": 0, "sort_order": sort,
        "description": description,
        "content": json.dumps({"prompt": prompt, "requires_file": requires_file}),
    }


def _ftpl(slug, name, icon, category, filename, content, sort, description):
    return {
        "id": _id(), "item_type": "file_template", "slug": slug, "name": name,
        "icon": icon, "category": category, "is_builtin": True, "is_featured": False,
        "install_count": 0, "sort_order": sort,
        "description": description,
        "content": json.dumps({"filename": filename, "content": content}),
    }


def _folder(slug, name, icon, category, root_name, structure, sort, description):
    return {
        "id": _id(), "item_type": "folder_template", "slug": slug, "name": name,
        "icon": icon, "category": category, "is_builtin": True, "is_featured": False,
        "install_count": 0, "sort_order": sort,
        "description": description,
        "content": json.dumps({"root_name": root_name, "structure": structure}),
    }


def _app(slug, name, icon, category, html, sort, description):
    return {
        "id": _id(), "item_type": "app", "slug": slug, "name": name,
        "icon": icon, "category": category, "is_builtin": True, "is_featured": False,
        "install_count": 0, "sort_order": sort,
        "description": description,
        "content": html,
    }


# ── COMMANDS ─────────────────────────────────────────────────────────────────

COMMANDS = [
    # Personal productivity
    _cmd("cmd-plan-week", "Plan My Week", "calendar-days", "personal",
         "Help me plan my upcoming week. Ask me about my goals, appointments, and priorities, then create a structured weekly plan with time blocks and task priorities.",
         False, 20, "Create a structured weekly plan with priorities"),
    _cmd("cmd-meal-plan", "Meal Planner", "utensils", "personal",
         "Create a weekly meal plan for me. Ask about my dietary preferences, budget, and number of people, then generate a 7-day plan with breakfast, lunch, dinner, and a grocery list.",
         False, 21, "Generate a weekly meal plan with grocery list"),
    _cmd("cmd-budget-review", "Budget Review", "wallet", "personal",
         'Read the file "{file_name}" and analyze my budget/finances. Identify spending patterns, suggest areas to cut back, compare to common budgeting rules (50/30/20), and provide actionable savings tips.',
         True, 22, "Analyze spending patterns and suggest savings"),
    _cmd("cmd-workout-plan", "Workout Plan", "dumbbell", "personal",
         "Create a personalized workout plan. Ask me about my fitness level, goals, available equipment, and time commitment, then generate a weekly exercise schedule with sets, reps, and rest days.",
         False, 23, "Generate a personalized exercise routine"),
    _cmd("cmd-travel-itinerary", "Travel Itinerary", "plane", "personal",
         "Help me plan a trip. Ask about my destination, dates, budget, and interests, then create a day-by-day itinerary with activities, restaurants, transportation, and estimated costs.",
         False, 24, "Create a detailed day-by-day travel plan"),
    _cmd("cmd-journal-prompt", "Journal Prompt", "pen-tool", "personal",
         "Give me a thoughtful journaling prompt to reflect on. Then after I write my response, provide insightful follow-up questions to deepen my self-reflection.",
         False, 25, "Get guided journaling prompts for self-reflection"),
    _cmd("cmd-study-guide", "Study Guide", "graduation-cap", "personal",
         "Help me create a study guide. Ask me what subject or topic I'm studying, then create a comprehensive guide with key concepts, definitions, practice questions, and memorization tips.",
         False, 26, "Create a comprehensive study guide on any topic"),
    _cmd("cmd-resume-builder", "Resume Builder", "file-user", "personal",
         "Help me build or improve my resume. Ask about my experience, skills, and target role, then create a professional resume in Markdown format optimized for ATS systems.",
         False, 27, "Build a professional ATS-optimized resume"),

    # Business productivity
    _cmd("cmd-write-prd", "Write PRD", "file-text", "business",
         "Help me write a Product Requirements Document. Ask about the product/feature, target users, and goals, then create a detailed PRD with: overview, user stories, requirements, success metrics, timeline, and open questions.",
         False, 30, "Create a detailed product requirements document"),
    _cmd("cmd-sprint-planning", "Sprint Planning", "kanban", "business",
         'Read the file "{file_name}" and help me plan the next sprint. Analyze the backlog, suggest which items to include based on priority and estimated effort, identify dependencies, and create a sprint goal.',
         True, 31, "Plan your next sprint from the backlog"),
    _cmd("cmd-competitive-analysis", "Competitive Analysis", "target", "business",
         "Help me analyze competitors. Ask about my product and 3-5 competitors, then create a detailed comparison matrix covering features, pricing, target market, strengths, weaknesses, and strategic recommendations.",
         False, 32, "Create a detailed competitive analysis matrix"),
    _cmd("cmd-swot-analysis", "SWOT Analysis", "grid-2x2", "business",
         "Help me perform a SWOT analysis. Ask about my business or project, then create a structured analysis of Strengths, Weaknesses, Opportunities, and Threats with actionable insights for each quadrant.",
         False, 33, "Perform a structured SWOT analysis"),
    _cmd("cmd-draft-email", "Draft Email", "mail", "business",
         "Help me draft a professional email. Ask about the recipient, purpose, and tone, then write a clear, well-structured email. Provide both a formal and a friendly version.",
         False, 34, "Draft professional emails with the right tone"),
    _cmd("cmd-user-stories", "Generate User Stories", "users", "business",
         "Help me write user stories for agile development. Ask about the feature or epic, then generate well-formatted user stories with acceptance criteria following the 'As a [user], I want [goal], so that [benefit]' format.",
         False, 35, "Generate agile user stories with acceptance criteria"),
    _cmd("cmd-status-update", "Status Update", "clipboard-list", "business",
         "Help me write a professional status update. Ask about my project progress, blockers, and upcoming work, then create a concise update suitable for stakeholders, covering accomplishments, current status, risks, and next steps.",
         False, 36, "Write a clear project status update"),
    _cmd("cmd-onboarding-plan", "Onboarding Plan", "user-plus", "business",
         "Help me create a new employee onboarding plan. Ask about the role and team, then create a 30-60-90 day plan with tasks, training milestones, key meetings, and success criteria.",
         False, 37, "Create a 30-60-90 day onboarding plan"),
    _cmd("cmd-risk-assessment", "Risk Assessment", "shield-alert", "business",
         'Read the file "{file_name}" and perform a risk assessment. Identify potential risks, assess their likelihood and impact, suggest mitigation strategies, and create a prioritized risk register.',
         True, 38, "Identify and assess project risks"),
    _cmd("cmd-okr-planning", "OKR Planning", "target", "business",
         "Help me set OKRs (Objectives and Key Results). Ask about my team and strategic goals, then create 3-5 well-structured objectives with measurable key results, target dates, and owners.",
         False, 39, "Set clear objectives and measurable key results"),
    _cmd("cmd-marketing-strategy", "Marketing Strategy", "megaphone", "business",
         "Help me create a marketing strategy. Ask about my product, audience, and budget, then develop a plan covering positioning, channels, content strategy, campaigns, KPIs, and timeline.",
         False, 40, "Develop a comprehensive marketing plan"),
    _cmd("cmd-customer-persona", "Customer Persona", "user-circle", "business",
         "Help me build detailed customer personas. Ask about my product and market, then create 2-3 personas with demographics, goals, pain points, behavior patterns, and preferred channels.",
         False, 41, "Build detailed customer persona profiles"),
    _cmd("cmd-create-sop", "Create SOP", "book-text", "business",
         "Help me create a Standard Operating Procedure document. Ask about the process, then create a step-by-step SOP with purpose, scope, responsibilities, procedure steps, and quality checks.",
         False, 42, "Write a standard operating procedure"),
    _cmd("cmd-interview-questions", "Interview Questions", "message-circle", "business",
         "Help me prepare interview questions. Ask about the role and key competencies, then generate behavioral, technical, and situational questions with example good answers and scoring rubrics.",
         False, 43, "Generate role-specific interview questions"),

    # Data & analysis
    _cmd("cmd-clean-data", "Clean Data", "filter", "analysis",
         'Read the file "{file_name}" and clean this data. Identify and fix: missing values, duplicates, inconsistent formatting, outliers, and type mismatches. Explain each change made.',
         True, 50, "Clean and standardize messy data"),
    _cmd("cmd-generate-report", "Generate Report", "file-bar-chart", "analysis",
         'Read the file "{file_name}" and generate a comprehensive report with executive summary, key findings, visualizations (as descriptions), trends, and recommendations.',
         True, 51, "Generate a detailed analytical report"),
]

# ── FILE TEMPLATES ───────────────────────────────────────────────────────────

FILE_TEMPLATES = [
    # Personal
    _ftpl("tpl-daily-journal", "Daily Journal", "pen-tool", "personal", "journal.md",
          "# Daily Journal\n\n## Date: YYYY-MM-DD\n\n### Gratitude\n1. \n2. \n3. \n\n### Today's Priorities\n- [ ] Priority 1\n- [ ] Priority 2\n- [ ] Priority 3\n\n### How I'm Feeling\n\n\n### What Happened Today\n\n\n### Lessons Learned\n\n\n### Tomorrow's Intentions\n\n",
          20, "Daily journaling template with gratitude and reflection"),

    _ftpl("tpl-grocery-list", "Grocery List", "shopping-cart", "personal", "grocery-list.csv",
          "Item,Category,Quantity,Unit,Notes\nBananas,Produce,1,bunch,Organic preferred\nChicken Breast,Meat,2,lbs,Boneless skinless\nWhole Milk,Dairy,1,gallon,\nBrown Rice,Grains,1,bag,\nBroccoli,Produce,2,heads,\nOlive Oil,Pantry,1,bottle,Extra virgin\nEggs,Dairy,1,dozen,Free range\nSourdough Bread,Bakery,1,loaf,\nGreek Yogurt,Dairy,4,cups,Plain\nGarlic,Produce,1,head,",
          21, "Organized grocery list by category"),

    _ftpl("tpl-fitness-tracker", "Fitness Tracker", "dumbbell", "personal", "fitness.csv",
          "Date,Exercise,Sets,Reps,Weight (lbs),Duration (min),Notes\n2025-01-06,Bench Press,4,10,135,\n2025-01-06,Squats,4,8,185,\n2025-01-06,Pull-ups,3,10,bodyweight,\n2025-01-06,Running,,,,30,5K pace\n2025-01-08,Deadlift,4,6,225,\n2025-01-08,Overhead Press,3,10,95,\n2025-01-08,Barbell Row,4,8,135,\n2025-01-10,Running,,,,45,Long run\n2025-01-10,Plank,3,,bodyweight,3,1 min holds",
          22, "Track workouts with sets, reps, and weight"),

    _ftpl("tpl-reading-list", "Reading List", "book-open", "personal", "reading-list.csv",
          "Title,Author,Genre,Status,Rating,Start Date,End Date,Notes\nAtomic Habits,James Clear,Self-Help,Read,5,2025-01-01,2025-01-15,Life changing\nDune,Frank Herbert,Sci-Fi,Reading,,2025-01-20,,Halfway through\nThinking Fast and Slow,Daniel Kahneman,Psychology,To Read,,,,Recommended by Alex\nThe Lean Startup,Eric Ries,Business,Read,4,2024-12-01,2024-12-20,Great for founders\nProject Hail Mary,Andy Weir,Sci-Fi,To Read,,,,",
          23, "Track books with reading status and ratings"),

    _ftpl("tpl-personal-budget", "Monthly Budget", "wallet", "personal", "budget.csv",
          "Category,Item,Budgeted,Actual,Type\nIncome,Salary,5000,5000,income\nIncome,Side Gig,500,350,income\nHousing,Rent,1500,1500,expense\nHousing,Utilities,200,180,expense\nTransportation,Car Payment,350,350,expense\nTransportation,Gas,150,130,expense\nFood,Groceries,400,450,expense\nFood,Dining Out,200,280,expense\nSavings,Emergency Fund,500,500,savings\nSavings,Retirement 401k,750,750,savings\nPersonal,Subscriptions,50,65,expense\nPersonal,Entertainment,150,120,expense",
          24, "Monthly budget tracker with income and expenses"),

    _ftpl("tpl-travel-checklist", "Travel Checklist", "plane", "personal", "travel-checklist.md",
          "# Travel Checklist\n\n**Trip:** \n**Dates:** \n**Destination:** \n\n## Before You Leave\n- [ ] Book flights\n- [ ] Book accommodation\n- [ ] Travel insurance\n- [ ] Check passport expiry\n- [ ] Visa requirements\n- [ ] Notify bank of travel\n- [ ] Set up out-of-office\n\n## Packing - Essentials\n- [ ] Passport / ID\n- [ ] Wallet / cards\n- [ ] Phone + charger\n- [ ] Power adapter\n- [ ] Medications\n- [ ] Travel documents (printed)\n\n## Packing - Clothes\n- [ ] Underwear (days + 1)\n- [ ] Socks\n- [ ] T-shirts / tops\n- [ ] Pants / shorts\n- [ ] Jacket / sweater\n- [ ] Sleepwear\n- [ ] Shoes\n\n## Packing - Toiletries\n- [ ] Toothbrush + toothpaste\n- [ ] Deodorant\n- [ ] Sunscreen\n- [ ] Shampoo / conditioner\n\n## Day of Travel\n- [ ] Lock all doors/windows\n- [ ] Unplug appliances\n- [ ] Water plants\n- [ ] Take out trash\n- [ ] Arrive at airport 2hrs early",
          25, "Complete travel packing and preparation checklist"),

    # Business
    _ftpl("tpl-prd", "Product Requirements Doc", "file-text", "business", "prd.md",
          "# Product Requirements Document\n\n**Product:** \n**Author:** \n**Date:** YYYY-MM-DD\n**Status:** Draft\n\n## 1. Overview\n\n### Problem Statement\nDescribe the problem this product/feature solves.\n\n### Goal\nWhat is the desired outcome?\n\n## 2. User Stories\n\n| As a... | I want to... | So that... |\n|---------|-------------|------------|\n| User | Do X | I can Y |\n\n## 3. Requirements\n\n### Must Have (P0)\n- Requirement 1\n- Requirement 2\n\n### Should Have (P1)\n- Requirement 3\n\n### Nice to Have (P2)\n- Requirement 4\n\n## 4. Design\n\n### User Flow\n1. Step 1\n2. Step 2\n3. Step 3\n\n### Wireframes\n*Attach links or descriptions*\n\n## 5. Success Metrics\n\n| Metric | Target | How to Measure |\n|--------|--------|----------------|\n| Metric 1 | X% | Analytics |\n\n## 6. Timeline\n\n| Phase | Duration | Deliverable |\n|-------|----------|-------------|\n| Design | 1 week | Mockups |\n| Dev | 2 weeks | MVP |\n| QA | 1 week | Release |\n\n## 7. Open Questions\n\n- Question 1\n- Question 2",
          30, "Complete PRD template with user stories and requirements"),

    _ftpl("tpl-product-backlog", "Product Backlog", "list-checks", "business", "backlog.csv",
          "ID,Epic,Story,Priority,Points,Status,Sprint,Assignee,Acceptance Criteria\nPB-001,User Auth,User registration with email,P0,5,Done,Sprint 1,Alice,User can register and receives verification email\nPB-002,User Auth,Social login (Google/GitHub),P1,3,In Progress,Sprint 2,Alice,User can sign in with Google or GitHub\nPB-003,Dashboard,Main dashboard layout,P0,8,In Progress,Sprint 2,Bob,Dashboard shows key metrics and recent activity\nPB-004,Dashboard,Customizable widgets,P2,13,Backlog,,Bob,Users can add/remove/reorder dashboard widgets\nPB-005,Search,Full-text search,P0,8,Backlog,,Charlie,Search across all content types with filters\nPB-006,Search,Search suggestions,P2,5,Backlog,,,Autocomplete suggestions as user types\nPB-007,Notifications,Email notifications,P1,5,Backlog,,,Users receive email for key events\nPB-008,Notifications,In-app notifications,P1,8,Backlog,,,Real-time notification bell with unread count\nPB-009,API,REST API v1,P0,13,Done,Sprint 1,Charlie,CRUD endpoints for all resources\nPB-010,API,Rate limiting,P1,3,Todo,Sprint 3,Charlie,Rate limits per API key",
          31, "Agile product backlog with epics and story points"),

    _ftpl("tpl-risk-register", "Risk Register", "shield-alert", "business", "risks.csv",
          "Risk ID,Risk,Category,Likelihood,Impact,Severity,Mitigation,Owner,Status,Last Review\nR-001,Key developer leaves,People,Medium,High,High,Cross-train team members; document architecture,Engineering Lead,Open,2025-01-15\nR-002,Scope creep delays launch,Schedule,High,High,Critical,Strict change control process; weekly scope reviews,PM,Open,2025-01-15\nR-003,Third-party API downtime,Technical,Medium,Medium,Medium,Implement circuit breaker; cache responses,Backend Lead,Open,2025-01-15\nR-004,Data breach,Security,Low,Critical,High,Regular security audits; encryption at rest,Security Lead,Open,2025-01-15\nR-005,Budget overrun,Financial,Medium,High,High,Monthly budget reviews; contingency fund,Finance,Open,2025-01-15",
          32, "Project risk register with severity and mitigation"),

    _ftpl("tpl-sales-pipeline", "Sales Pipeline", "trending-up", "business", "pipeline.csv",
          "Company,Contact,Email,Deal Value,Stage,Probability,Expected Close,Source,Last Activity,Notes\nAcme Corp,John Smith,john@acme.com,50000,Proposal,60%,2025-03-15,Inbound,2025-01-20,Sent revised proposal\nTechStart,Sarah Lee,sarah@techstart.io,25000,Negotiation,80%,2025-02-28,Referral,2025-01-22,Contract review in progress\nGlobal Inc,Mike Chen,mike@global.com,120000,Discovery,30%,2025-04-30,Conference,2025-01-18,Scheduled demo for Feb 1\nDataFlow,Anna Park,anna@dataflow.co,35000,Qualified,40%,2025-03-30,Cold Outreach,2025-01-15,Interested in enterprise plan\nCloudBase,Tom Wilson,tom@cloudbase.io,75000,Closed Won,100%,2025-01-10,Partner,2025-01-10,Signed annual contract",
          33, "Sales pipeline with stages and deal values"),

    _ftpl("tpl-employee-directory", "Employee Directory", "users", "business", "employees.csv",
          "Name,Email,Department,Role,Location,Start Date,Manager,Phone,Status\nAlice Johnson,alice@company.com,Engineering,Senior Developer,New York,2023-03-15,Bob Smith,555-0101,Active\nBob Smith,bob@company.com,Engineering,Engineering Manager,New York,2022-01-10,,555-0102,Active\nCarol Williams,carol@company.com,Design,Lead Designer,Remote,2023-06-01,Bob Smith,555-0103,Active\nDavid Brown,david@company.com,Marketing,Marketing Manager,San Francisco,2022-08-20,,555-0104,Active\nEva Martinez,eva@company.com,Sales,Account Executive,Chicago,2024-01-15,Frank Lee,555-0105,Active\nFrank Lee,frank@company.com,Sales,VP Sales,Chicago,2021-11-01,,555-0106,Active",
          34, "Company employee directory with departments and roles"),

    _ftpl("tpl-content-calendar", "Content Calendar", "calendar-days", "business", "content-calendar.csv",
          "Date,Title,Type,Channel,Status,Author,Topic,Notes\n2025-02-03,10 Tips for Remote Work,Blog Post,Website,Published,Alice,Productivity,SEO optimized\n2025-02-05,Product Update Video,Video,YouTube,Published,Bob,Product,Include demo\n2025-02-07,Customer Success Story,Case Study,Website,In Review,Carol,Social Proof,Interview with Acme Corp\n2025-02-10,Weekly Newsletter,Email,Email List,Scheduled,Alice,Roundup,Include blog links\n2025-02-12,Industry Trends 2025,Blog Post,Website,Drafting,David,Thought Leadership,\n2025-02-14,Valentine's Day Promo,Social Post,Instagram,Scheduled,Carol,Marketing,Use new brand assets\n2025-02-17,How-To Tutorial,Video,YouTube,Planning,Bob,Education,Screen recording needed\n2025-02-19,Webinar: Best Practices,Event,Zoom,Planning,David,Education,Need guest speaker",
          35, "Content planning calendar with types and channels"),

    _ftpl("tpl-okr-template", "OKR Template", "target", "business", "okrs.csv",
          "Objective,Key Result,Progress,Owner,Quarter,Status\nIncrease revenue by 30%,Grow MRR from $100k to $130k,45,Sales Lead,Q1 2025,On Track\nIncrease revenue by 30%,Close 15 enterprise deals,8,Sales Team,Q1 2025,On Track\nIncrease revenue by 30%,Reduce churn to below 3%,60,CS Team,Q1 2025,At Risk\nImprove product quality,Reduce bug backlog by 50%,70,Engineering,Q1 2025,On Track\nImprove product quality,Achieve 99.9% uptime,85,DevOps,Q1 2025,On Track\nImprove product quality,Increase test coverage to 80%,55,Engineering,Q1 2025,Behind\nGrow user base,Reach 10k active users,40,Marketing,Q1 2025,On Track\nGrow user base,Launch referral program,20,Growth,Q1 2025,Behind\nGrow user base,Improve onboarding completion to 70%,65,Product,Q1 2025,On Track",
          36, "OKR tracking template with objectives and key results"),

    _ftpl("tpl-raci-matrix", "RACI Matrix", "grid-2x2", "business", "raci.csv",
          "Task,Project Manager,Developer,Designer,QA,Stakeholder\nProject Planning,A,C,C,I,R\nRequirements Gathering,R,C,C,I,A\nUI/UX Design,I,C,R,I,A\nBackend Development,I,R,C,C,I\nFrontend Development,I,R,C,C,I\nTesting,I,C,I,R,I\nDeployment,A,R,I,C,I\nDocumentation,A,R,C,C,I\nStakeholder Review,R,I,I,I,A\nRelease Sign-off,R,I,I,C,A",
          37, "RACI responsibility matrix (Responsible/Accountable/Consulted/Informed)"),

    _ftpl("tpl-competitive-matrix", "Competitive Analysis", "target", "business", "competitive-analysis.csv",
          "Feature,Our Product,Competitor A,Competitor B,Competitor C\nPricing (monthly),$29,$49,$19,$39\nFree Tier,Yes,No,Yes (limited),No\nAPI Access,Yes,Yes,No,Yes\nMobile App,Yes,Yes,Yes,No\nCustom Integrations,Yes,Limited,No,Yes\nSSO Support,Yes,Enterprise only,No,Yes\nFile Storage,Unlimited,10GB,5GB,50GB\nTeam Collaboration,Yes,Yes,Limited,Yes\nCustom Branding,Yes,No,No,Yes\nPriority Support,All plans,Enterprise,No,Premium\n24/7 Uptime SLA,99.9%,99.5%,99%,99.9%",
          38, "Side-by-side competitive feature comparison matrix"),

    _ftpl("tpl-invoice", "Invoice", "receipt", "business", "invoice.csv",
          "Item,Description,Quantity,Unit Price,Tax Rate\nWebsite Design,Custom responsive website design,1,3500,10\nLogo Design,Brand logo with 3 revisions,1,800,10\nHosting Setup,Server configuration and deployment,1,250,10\nContent Writing,5 pages of website copy,5,150,10\nSEO Optimization,On-page SEO for all pages,1,500,10",
          39, "Invoice line items template with tax calculation"),

    _ftpl("tpl-retrospective", "Sprint Retrospective", "rotate-ccw", "business", "retro.csv",
          "Category,Item,Author,Votes\nWhat went well,Shipped the new dashboard on time,Alice,5\nWhat went well,Great collaboration between design and dev,Bob,4\nWhat went well,Zero critical bugs in production,Charlie,3\nWhat to improve,Stand-ups running too long,Alice,4\nWhat to improve,Test coverage could be better,Diana,3\nWhat to improve,Documentation was an afterthought,Bob,2\nAction items,Timebox stand-ups to 10 minutes,PM,5\nAction items,Add test coverage to PR checklist,Charlie,4\nAction items,Write docs alongside feature development,Diana,3",
          40, "Sprint retrospective with categories and voting"),

    _ftpl("tpl-customer-feedback", "Customer Feedback", "message-circle", "business", "feedback.csv",
          "Date,Customer,Channel,Category,Sentiment,Feedback,Priority,Status\n2025-01-20,Acme Corp,Email,Feature Request,Positive,Would love to see calendar integration,Medium,Under Review\n2025-01-19,TechStart,Support Ticket,Bug,Negative,Export to PDF not working on Safari,High,In Progress\n2025-01-18,Global Inc,Survey,UX,Neutral,Dashboard could use better filtering,Medium,Planned\n2025-01-17,DataFlow,Chat,Performance,Negative,Page load times slow on large datasets,High,In Progress\n2025-01-15,CloudBase,Interview,Praise,Positive,Love the new collaboration features,Low,Noted",
          41, "Customer feedback tracker with sentiment and priority"),
]

# ── FOLDER TEMPLATES ─────────────────────────────────────────────────────────

FOLDER_TEMPLATES = [
    _folder("ftpl-marketing-campaign", "Marketing Campaign", "megaphone", "business", "Marketing Campaign", [
        {"type": "file", "name": "campaign-brief.md", "content": "# Campaign Brief\n\n**Campaign Name:** \n**Launch Date:** \n**Owner:** \n\n## Objective\nWhat is the goal of this campaign?\n\n## Target Audience\n- Segment 1\n- Segment 2\n\n## Key Messages\n1. Message 1\n2. Message 2\n\n## Channels\n- [ ] Email\n- [ ] Social Media\n- [ ] Blog\n- [ ] Paid Ads\n\n## Budget\n| Channel | Budget | Expected ROI |\n|---------|--------|--------------|\n| Email | $X | X% |\n\n## Timeline\n| Phase | Dates | Deliverables |\n|-------|-------|--------------|\n| Planning | Week 1 | Brief, assets |\n| Launch | Week 2 | Go live |\n| Monitor | Weeks 3-4 | Reports |"},
        {"type": "file", "name": "content-calendar.csv", "content": "Date,Content,Type,Channel,Status,Owner\n2025-02-01,Teaser Post,Social,Instagram,Draft,Marketing\n2025-02-03,Launch Email,Email,Newsletter,Draft,Marketing\n2025-02-03,Blog Post,Article,Website,Draft,Content\n2025-02-05,Follow-up Email,Email,Newsletter,Planned,Marketing\n2025-02-07,Case Study,Article,Website,Planned,Content"},
        {"type": "file", "name": "campaign-metrics.csv", "content": "Metric,Target,Actual,Channel\nImpressions,100000,,All\nClick-Through Rate,2.5%,,All\nConversions,500,,All\nEmail Open Rate,25%,,Email\nSocial Engagement,5%,,Social\nCost Per Acquisition,$20,,Paid"},
        {"type": "file", "name": "assets.md", "content": "# Campaign Assets\n\n## Copy\n- [ ] Email subject lines (3 variants)\n- [ ] Blog post draft\n- [ ] Social media captions\n- [ ] Ad copy (3 variants)\n\n## Design\n- [ ] Email banner\n- [ ] Social media graphics\n- [ ] Blog header image\n- [ ] Ad creatives\n\n## Links\n- Landing page: \n- UTM Builder: \n- Analytics dashboard: "},
    ], 20, "Complete marketing campaign kit with brief, calendar, and metrics"),

    _folder("ftpl-client-onboarding", "Client Onboarding", "user-plus", "business", "Client Onboarding", [
        {"type": "file", "name": "onboarding-checklist.md", "content": "# Client Onboarding Checklist\n\n**Client:** \n**Start Date:** \n**Account Manager:** \n\n## Week 1: Kickoff\n- [ ] Welcome email sent\n- [ ] Kickoff meeting scheduled\n- [ ] Access credentials shared\n- [ ] Contract signed\n- [ ] NDA executed\n\n## Week 2: Setup\n- [ ] Account configured\n- [ ] Data migration started\n- [ ] Initial training session\n- [ ] Key contacts identified\n\n## Week 3: Training\n- [ ] User training complete\n- [ ] Admin training complete\n- [ ] Documentation shared\n- [ ] Support channels established\n\n## Week 4: Go-Live\n- [ ] Production deployment\n- [ ] Smoke testing\n- [ ] User acceptance sign-off\n- [ ] Handoff to support team"},
        {"type": "file", "name": "client-info.csv", "content": "Field,Value\nCompany Name,\nIndustry,\nPrimary Contact,\nEmail,\nPhone,\nPlan Type,\nContract Start,\nContract End,\nAnnual Value,\nSpecial Requirements,"},
        {"type": "file", "name": "meeting-notes.md", "content": "# Onboarding Meeting Notes\n\n## Kickoff Meeting\n**Date:** \n**Attendees:** \n\n### Agenda\n1. Introductions\n2. Project overview\n3. Timeline review\n4. Q&A\n\n### Notes\n\n\n### Action Items\n- [ ] Action 1 - Owner - Due\n- [ ] Action 2 - Owner - Due"},
    ], 21, "Client onboarding workflow with checklist and tracking"),

    _folder("ftpl-hr-toolkit", "HR Toolkit", "briefcase", "business", "HR Toolkit", [
        {"type": "file", "name": "employees.csv", "content": "Name,Email,Department,Role,Start Date,Manager,Location,Status\nJane Smith,jane@co.com,Engineering,Senior Dev,2023-05-01,John Doe,Remote,Active\nJohn Doe,john@co.com,Engineering,VP Engineering,2022-01-15,,New York,Active"},
        {"type": "file", "name": "open-positions.csv", "content": "Position,Department,Level,Location,Status,Posted Date,Applications,Hiring Manager\nSenior Frontend Dev,Engineering,Senior,Remote,Open,2025-01-10,12,John Doe\nProduct Designer,Design,Mid,New York,Interviewing,2025-01-05,25,Sarah Lee\nData Analyst,Analytics,Junior,Remote,Open,2025-01-15,8,Mike Chen"},
        {"type": "file", "name": "onboarding-template.md", "content": "# New Hire Onboarding\n\n**Employee:** \n**Role:** \n**Start Date:** \n**Manager:** \n**Buddy:** \n\n## Pre-Start\n- [ ] Offer letter signed\n- [ ] Background check complete\n- [ ] Equipment ordered\n- [ ] Accounts created (email, Slack, tools)\n\n## Day 1\n- [ ] Welcome meeting with manager\n- [ ] Office/remote setup tour\n- [ ] HR orientation\n- [ ] Team introduction\n\n## Week 1\n- [ ] 1:1 with manager\n- [ ] Meet buddy\n- [ ] Review team goals\n- [ ] Complete required training\n\n## 30 Days\n- [ ] First project assigned\n- [ ] 30-day check-in\n- [ ] Feedback session"},
        {"type": "file", "name": "policies.md", "content": "# Company Policies\n\n## Time Off\n- PTO: 20 days/year\n- Sick days: 10 days/year\n- Holidays: Company calendar\n\n## Remote Work\n- Hybrid: 2-3 days in office\n- Fully remote positions available\n- Home office stipend: $500/year\n\n## Benefits\n- Health insurance\n- 401(k) match up to 4%\n- Learning budget: $1000/year"},
    ], 22, "HR toolkit with employee directory, positions, and policies"),

    _folder("ftpl-event-planning", "Event Planning", "calendar-days", "personal", "Event Planning", [
        {"type": "file", "name": "event-overview.md", "content": "# Event Planning\n\n**Event:** \n**Date:** \n**Venue:** \n**Budget:** \n**Organizer:** \n\n## Event Details\n- Type: (conference/meetup/party/workshop)\n- Expected attendees: \n- Duration: \n- Theme: \n\n## Checklist\n\n### 8+ Weeks Before\n- [ ] Set date and venue\n- [ ] Create budget\n- [ ] Book speakers/entertainment\n\n### 4 Weeks Before\n- [ ] Send invitations\n- [ ] Confirm catering\n- [ ] Plan agenda/program\n\n### 1 Week Before\n- [ ] Final headcount\n- [ ] Confirm all vendors\n- [ ] Print materials\n\n### Day Of\n- [ ] Venue setup\n- [ ] Welcome attendees\n- [ ] Run event\n- [ ] Clean up"},
        {"type": "file", "name": "guest-list.csv", "content": "Name,Email,RSVP,Dietary,Plus One,Table,Notes\nAlice Johnson,alice@email.com,Yes,Vegetarian,1,1,\nBob Smith,bob@email.com,Yes,None,0,1,\nCarol Williams,carol@email.com,Pending,Vegan,1,2,\nDavid Brown,david@email.com,No,,,, Can't make it"},
        {"type": "file", "name": "budget.csv", "content": "Item,Category,Estimated,Actual,Status\nVenue Rental,Venue,2000,,Booked\nCatering (per person),Food,45,,Quote received\nAV Equipment,Equipment,500,,Researching\nDecorations,Decor,300,,\nPhotographer,Services,800,,\nPrinting (invites/programs),Materials,200,,"},
    ], 23, "Complete event planning kit with guest list and budget"),

    _folder("ftpl-product-launch", "Product Launch", "rocket", "business", "Product Launch", [
        {"type": "file", "name": "launch-plan.md", "content": "# Product Launch Plan\n\n**Product:** \n**Launch Date:** \n**Launch Owner:** \n\n## Pre-Launch (4 weeks before)\n- [ ] Feature complete and tested\n- [ ] Landing page ready\n- [ ] Press kit prepared\n- [ ] Beta testers feedback incorporated\n- [ ] Pricing finalized\n\n## Launch Week\n- [ ] Deploy to production\n- [ ] Publish blog post\n- [ ] Send email announcement\n- [ ] Social media campaign\n- [ ] Submit to Product Hunt\n- [ ] Notify press contacts\n\n## Post-Launch\n- [ ] Monitor metrics\n- [ ] Respond to feedback\n- [ ] Fix critical bugs\n- [ ] Retrospective meeting\n- [ ] Plan next iteration"},
        {"type": "file", "name": "launch-tasks.csv", "content": "Task,Owner,Due Date,Status,Priority,Category\nFinalize feature set,Product,T-28,Done,P0,Product\nQA and testing,Engineering,T-14,In Progress,P0,Engineering\nCreate landing page,Marketing,T-14,In Progress,P0,Marketing\nWrite blog post,Content,T-7,Todo,P1,Marketing\nPrepare email campaign,Marketing,T-7,Todo,P1,Marketing\nCreate social media assets,Design,T-7,Todo,P1,Marketing\nSet up analytics,Engineering,T-3,Todo,P0,Engineering\nDeploy to production,Engineering,T-0,Todo,P0,Engineering\nProduct Hunt submission,Marketing,T-0,Todo,P1,Marketing\nPost-launch review,Product,T+7,Todo,P2,Product"},
        {"type": "file", "name": "metrics.csv", "content": "Metric,Target,Day 1,Week 1,Month 1\nSign-ups,1000,,,\nActive Users,500,,,\nConversion Rate,5%,,,\nNPS Score,50,,,\nRevenue,$10000,,,\nSupport Tickets,<50,,,"},
    ], 24, "Product launch playbook with tasks, timeline, and metrics"),

    _folder("ftpl-sales-ops", "Sales Operations", "trending-up", "business", "Sales Operations", [
        {"type": "file", "name": "pipeline.csv", "content": "Company,Contact,Deal Value,Stage,Probability,Close Date,Source,Owner\nAcme Corp,John Smith,50000,Proposal,60%,2025-03-15,Inbound,Rep A\nTechStart,Sarah Lee,25000,Negotiation,80%,2025-02-28,Referral,Rep B\nGlobal Inc,Mike Chen,120000,Discovery,30%,2025-04-30,Conference,Rep A"},
        {"type": "file", "name": "targets.csv", "content": "Rep,Q1 Target,Q1 Actual,Q2 Target,Q2 Actual,Annual Target\nRep A,150000,80000,175000,,600000\nRep B,120000,95000,140000,,500000\nRep C,100000,60000,120000,,400000\nTeam Total,370000,235000,435000,,1500000"},
        {"type": "file", "name": "call-log.csv", "content": "Date,Company,Contact,Type,Duration (min),Outcome,Next Step,Rep\n2025-01-22,Acme Corp,John Smith,Demo,45,Positive,Send proposal,Rep A\n2025-01-21,TechStart,Sarah Lee,Follow-up,20,Contract review,Schedule legal call,Rep B\n2025-01-20,Global Inc,Mike Chen,Discovery,60,Interested,Send case studies,Rep A"},
        {"type": "file", "name": "playbook.md", "content": "# Sales Playbook\n\n## Sales Process\n1. **Prospecting** - Identify potential customers\n2. **Discovery** - Understand needs and pain points\n3. **Demo** - Show product value\n4. **Proposal** - Send pricing and scope\n5. **Negotiation** - Handle objections\n6. **Close** - Sign contract\n\n## Email Templates\n\n### Cold Outreach\nSubject: [Relevant trigger] for [Company]\n\nHi [Name],\n\nI noticed [trigger event]. [Value prop in one sentence].\n\nWould you be open to a 15-minute call this week?\n\n### Follow-Up\nSubject: Re: [Previous subject]\n\nHi [Name],\n\nJust following up on my previous message. [Add new value/insight].\n\n## Objection Handling\n| Objection | Response |\n|-----------|----------|\n| Too expensive | Focus on ROI and total cost of ownership |\n| Not the right time | Understand timeline; offer to stay in touch |\n| Using a competitor | Highlight differentiators |"},
    ], 25, "Sales operations hub with pipeline, targets, and playbook"),

    _folder("ftpl-qbr", "Quarterly Business Review", "bar-chart-3", "business", "QBR - Q1 2025", [
        {"type": "file", "name": "executive-summary.md", "content": "# Q1 2025 Quarterly Business Review\n\n**Date:** \n**Presenter:** \n\n## Executive Summary\n\nQ1 highlights and overall performance summary.\n\n## Key Wins\n1. Win 1\n2. Win 2\n3. Win 3\n\n## Challenges\n1. Challenge 1\n2. Challenge 2\n\n## Q2 Priorities\n1. Priority 1\n2. Priority 2\n3. Priority 3"},
        {"type": "file", "name": "kpis.csv", "content": "Metric,Q4 2024,Q1 Target,Q1 Actual,YoY Change,Status\nRevenue,450000,500000,,+10%,\nNew Customers,120,150,,+25%,\nChurn Rate,4.2%,3.5%,,Target: decrease,\nNPS Score,42,50,,Target: increase,\nEmployee Count,45,52,,+15%,\nBurn Rate,80000,85000,,Controlled,"},
        {"type": "file", "name": "financials.csv", "content": "Category,Q4 2024,Q1 2025 Budget,Q1 2025 Actual,Variance\nRevenue,450000,500000,,\nCOGS,90000,100000,,\nGross Profit,360000,400000,,\nSalaries,200000,230000,,\nMarketing,40000,50000,,\nOperations,30000,35000,,\nNet Income,90000,85000,,"},
        {"type": "file", "name": "action-items.csv", "content": "Action Item,Owner,Due Date,Status,Priority\nHire 3 engineers,VP Engineering,2025-04-30,In Progress,High\nLaunch enterprise plan,Product,2025-04-15,Planning,High\nReduce churn by 1%,CS Team,2025-06-30,In Progress,High\nRedesign onboarding flow,Design,2025-05-15,Planning,Medium"},
    ], 26, "Quarterly business review with KPIs, financials, and action items"),

    _folder("ftpl-content-hub", "Content Marketing Hub", "pen-tool", "business", "Content Hub", [
        {"type": "folder", "name": "blog-posts", "children": [
            {"type": "file", "name": "post-template.md", "content": "# Blog Post Title\n\n**Author:** \n**Date:** \n**Category:** \n**Tags:** \n**Status:** Draft\n\n## Introduction\n\nHook the reader with a compelling opening.\n\n## Main Content\n\n### Section 1\n\n### Section 2\n\n### Section 3\n\n## Conclusion\n\nSummarize key points and include a call-to-action.\n\n---\n*SEO Notes:*\n- Target keyword: \n- Meta description: \n- Word count target: 1500"},
        ]},
        {"type": "file", "name": "content-calendar.csv", "content": "Week,Monday,Wednesday,Friday\nWeek 1,Blog: Industry Trends,Social: Tips Thread,Newsletter\nWeek 2,Case Study,Social: Poll,Blog: How-To\nWeek 3,Blog: Product Update,Social: Behind the Scenes,Webinar\nWeek 4,Guest Post,Social: User Spotlight,Newsletter"},
        {"type": "file", "name": "content-ideas.csv", "content": "Title,Type,Target Keyword,Difficulty,Priority,Status\n10 Tips for Productivity,Blog Post,productivity tips,Medium,High,Draft\nCustomer Success Story: Acme,Case Study,case study,Low,High,Planned\nGetting Started Guide,Tutorial,getting started,Low,Medium,Planned\nIndustry Report 2025,Whitepaper,industry trends,High,Medium,Idea\nProduct Comparison Guide,Blog Post,vs competitor,Medium,Low,Idea"},
        {"type": "file", "name": "style-guide.md", "content": "# Content Style Guide\n\n## Voice & Tone\n- **Professional** but approachable\n- **Clear** over clever\n- **Helpful** and actionable\n\n## Writing Guidelines\n- Use active voice\n- Keep sentences short (under 25 words)\n- One idea per paragraph\n- Use headers every 200-300 words\n\n## Formatting\n- H1: Title only\n- H2: Main sections\n- H3: Subsections\n- Use bullet points for lists\n- Bold for emphasis (not italics)\n\n## SEO Checklist\n- [ ] Target keyword in title\n- [ ] Keyword in first 100 words\n- [ ] Meta description (155 chars)\n- [ ] Alt text on images\n- [ ] Internal links (2-3)"},
    ], 27, "Content marketing workspace with calendar, ideas, and style guide"),

    _folder("ftpl-personal-finance", "Personal Finance", "wallet", "personal", "My Finances", [
        {"type": "file", "name": "monthly-budget.csv", "content": "Category,Item,Budgeted,Actual,Type\nIncome,Salary,5000,,income\nIncome,Side Gig,500,,income\nHousing,Rent/Mortgage,1500,,expense\nHousing,Utilities,200,,expense\nFood,Groceries,400,,expense\nFood,Dining Out,200,,expense\nTransport,Car/Transit,300,,expense\nSavings,Emergency Fund,500,,savings\nSavings,Investments,500,,savings\nPersonal,Entertainment,200,,expense\nPersonal,Subscriptions,50,,expense"},
        {"type": "file", "name": "net-worth.csv", "content": "Account,Type,Balance,Institution,Notes\nChecking,Asset,5000,Bank A,Main account\nSavings,Asset,15000,Bank A,Emergency fund\n401k,Asset,45000,Vanguard,Employer match 4%\nRoth IRA,Asset,12000,Fidelity,Max contribution annually\nCredit Card,Liability,-2000,Chase,Pay in full monthly\nStudent Loans,Liability,-25000,FedLoan,10 year plan"},
        {"type": "file", "name": "goals.md", "content": "# Financial Goals\n\n## Short-Term (< 1 year)\n- [ ] Build 3-month emergency fund ($15,000)\n- [ ] Pay off credit card balance\n- [ ] Start investing $500/month\n\n## Medium-Term (1-5 years)\n- [ ] Build 6-month emergency fund ($30,000)\n- [ ] Save for down payment ($50,000)\n- [ ] Pay off student loans\n\n## Long-Term (5+ years)\n- [ ] Max out retirement contributions\n- [ ] Achieve $500K net worth\n- [ ] Generate passive income streams"},
    ], 28, "Personal finance tracker with budget, net worth, and goals"),
]


# ── APP HTML TEMPLATES ───────────────────────────────────────────────────────

_CRM_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:8px;font-size:20px}.stats{display:flex;gap:12px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}.stat-card{background:white;padding:12px 20px;border-radius:10px;border:1px solid #e2e8f0;text-align:center}.stat-card .num{font-size:22px;font-weight:700;color:#1e293b}.stat-card .label{font-size:11px;color:#94a3b8}.pipeline{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px}.column{min-width:220px;flex:1;background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}.col-header{padding:12px 16px;font-size:13px;font-weight:600;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}.col-header .count{background:#f1f5f9;padding:2px 8px;border-radius:10px;font-size:11px;color:#64748b}.col-body{padding:8px}.card{padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid #f1f5f9;background:#fafafa;cursor:default}.card:hover{border-color:#cbd5e1}.card .name{font-size:13px;font-weight:600;color:#1e293b}.card .company{font-size:11px;color:#64748b;margin-top:2px}.card .value{font-size:12px;font-weight:600;color:#059669;margin-top:6px}.card .meta{font-size:10px;color:#94a3b8;margin-top:4px}</style></head><body><h1>CRM Pipeline</h1><div class="stats" id="stats"></div><div class="pipeline" id="pipeline"></div><script>const COLORS={lead:'#6366f1',prospect:'#f59e0b',customer:'#22c55e',churned:'#ef4444'};function render(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const ni=h.findIndex(x=>x.includes('name'));const ei=h.findIndex(x=>x.includes('email'));const ci=h.findIndex(x=>x.includes('company'));const si=h.findIndex(x=>x.includes('status')||x.includes('stage'));const vi=h.findIndex(x=>x.includes('value')||x.includes('deal'));const di=h.findIndex(x=>x.includes('last')||x.includes('date')||x.includes('contact'));const rows=lines.slice(1).map(l=>{const c=l.split(',').map(s=>s.trim());return{name:c[ni]||c[0],email:ei>=0?c[ei]:'',company:ci>=0?c[ci]:'',status:(si>=0?c[si]:c[3]||'').toLowerCase(),value:vi>=0?parseFloat(c[vi])||0:0,date:di>=0?c[di]:''};});const stages=[...new Set(rows.map(r=>r.status))];const totalVal=rows.reduce((s,r)=>s+r.value,0);document.getElementById('stats').innerHTML=`<div class="stat-card"><div class="num">${rows.length}</div><div class="label">Contacts</div></div><div class="stat-card"><div class="num">$${totalVal.toLocaleString()}</div><div class="label">Total Value</div></div><div class="stat-card"><div class="num">${stages.length}</div><div class="label">Stages</div></div>`;const pl=document.getElementById('pipeline');stages.forEach(stage=>{const items=rows.filter(r=>r.status===stage);const color=COLORS[stage]||'#6366f1';pl.innerHTML+=`<div class="column"><div class="col-header" style="color:${color}">${stage.charAt(0).toUpperCase()+stage.slice(1)}<span class="count">${items.length}</span></div><div class="col-body">${items.map(r=>`<div class="card"><div class="name">${r.name}</div>${r.company?`<div class="company">${r.company}</div>`:''}${r.value?`<div class="value">$${r.value.toLocaleString()}</div>`:''}${r.date?`<div class="meta">${r.date}</div>`:''}</div>`).join('')}</div></div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Name, Company, Status, and Value columns.</p>';</script></body></html>'''

_SPRINT_BOARD_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:4px;font-size:20px}.controls{text-align:center;margin-bottom:16px}select{padding:6px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;color:#334155}.board{display:flex;gap:12px;overflow-x:auto;padding-bottom:8px}.column{min-width:230px;flex:1;background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}.col-header{padding:12px 16px;font-weight:600;font-size:13px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}.col-header .badge{padding:2px 8px;border-radius:10px;font-size:11px;background:#f1f5f9;color:#64748b}.col-body{padding:8px}.card{padding:12px;margin-bottom:8px;border-radius:8px;border:1px solid #f1f5f9;background:#fafafa}.card .title{font-size:13px;font-weight:600;color:#1e293b;margin-bottom:6px}.card .bottom{display:flex;justify-content:space-between;align-items:center}.avatar{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:600;color:white}.priority{font-size:10px;font-weight:600;padding:2px 6px;border-radius:4px}.points{font-size:11px;color:#94a3b8;font-weight:600}</style></head><body><h1>Sprint Board</h1><div class="controls"><select id="sprintFilter" onchange="rerender()"><option value="">All Sprints</option></select></div><div class="board" id="board"></div><script>let ALL_ROWS=[];const STATUS_ORDER=['todo','to do','in progress','in review','review','done','closed'];const PRIORITY_COLORS={high:'#fee2e2;color:#dc2626',medium:'#fef3c7;color:#d97706',low:'#dcfce7;color:#16a34a'};const AVATAR_COLORS=['#6366f1','#ec4899','#f59e0b','#22c55e','#3b82f6','#8b5cf6'];function parse(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const ti=h.findIndex(x=>x.includes('task')||x.includes('title')||x.includes('story'));const si=h.findIndex(x=>x.includes('status'));const pi=h.findIndex(x=>x.includes('priority'));const ai=h.findIndex(x=>x.includes('assignee')||x.includes('owner'));const pti=h.findIndex(x=>x.includes('point'));const spi=h.findIndex(x=>x.includes('sprint'));ALL_ROWS=lines.slice(1).map(l=>{const c=l.split(',').map(s=>s.trim());return{task:c[ti>=0?ti:0],status:(c[si>=0?si:1]||'').toLowerCase(),priority:(c[pi>=0?pi:2]||'').toLowerCase(),assignee:c[ai>=0?ai:3]||'',points:pti>=0?c[pti]:'',sprint:spi>=0?c[spi]:''}});const sprints=[...new Set(ALL_ROWS.map(r=>r.sprint).filter(Boolean))];const sel=document.getElementById('sprintFilter');sprints.forEach(s=>{sel.innerHTML+=`<option value="${s}">${s}</option>`;});}function rerender(){const filter=document.getElementById('sprintFilter').value;const rows=filter?ALL_ROWS.filter(r=>r.sprint===filter):ALL_ROWS;const statuses=[...new Set(rows.map(r=>r.status))];statuses.sort((a,b)=>{const ia=STATUS_ORDER.findIndex(s=>a.includes(s));const ib=STATUS_ORDER.findIndex(s=>b.includes(s));return(ia===-1?99:ia)-(ib===-1?99:ib);});const board=document.getElementById('board');board.innerHTML='';const assignees={};statuses.forEach(st=>{const items=rows.filter(r=>r.status===st);board.innerHTML+=`<div class="column"><div class="col-header">${st.charAt(0).toUpperCase()+st.slice(1)}<span class="badge">${items.length}</span></div><div class="col-body">${items.map(r=>{if(r.assignee&&!assignees[r.assignee]){assignees[r.assignee]=AVATAR_COLORS[Object.keys(assignees).length%AVATAR_COLORS.length];}const color=assignees[r.assignee]||'#94a3b8';const pStyle=PRIORITY_COLORS[r.priority]||'#f1f5f9;color:#64748b';return`<div class="card"><div class="title">${r.task}</div><div class="bottom"><div style="display:flex;align-items:center;gap:6px">${r.assignee?`<div class="avatar" style="background:${color}">${r.assignee.charAt(0).toUpperCase()}</div>`:''}<span class="priority" style="background:${pStyle}">${r.priority||'—'}</span></div>${r.points?`<span class="points">${r.points} pts</span>`:''}</div></div>`;}).join('')}</div></div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data){parse(data);rerender();}else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Task, Status, Priority, Assignee, Points columns.</p>';</script></body></html>'''

_OKR_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:8px;font-size:20px}.summary{display:flex;gap:12px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}.sum-card{background:white;padding:12px 20px;border-radius:10px;border:1px solid #e2e8f0;text-align:center}.sum-card .num{font-size:22px;font-weight:700;color:#1e293b}.sum-card .label{font-size:11px;color:#94a3b8}.objectives{max-width:800px;margin:0 auto}.obj{background:white;border-radius:12px;border:1px solid #e2e8f0;margin-bottom:16px;overflow:hidden}.obj-header{padding:16px;border-bottom:1px solid #f1f5f9;display:flex;justify-content:space-between;align-items:center}.obj-header .title{font-size:15px;font-weight:600;color:#1e293b}.obj-header .pct{font-size:14px;font-weight:700;padding:4px 10px;border-radius:8px}.bar-track{height:6px;background:#f1f5f9;border-radius:3px;margin:0 16px 8px}.bar-fill{height:100%;border-radius:3px;transition:width 0.5s}.kr{padding:12px 16px;border-bottom:1px solid #f8fafc;display:flex;align-items:center;gap:12px}.kr:last-child{border-bottom:none}.kr .kr-info{flex:1}.kr .kr-name{font-size:13px;color:#334155}.kr .kr-owner{font-size:11px;color:#94a3b8}.kr .kr-bar{width:120px}.kr .kr-pct{font-size:12px;font-weight:600;width:40px;text-align:right}</style></head><body><h1>OKR Tracker</h1><div class="summary" id="summary"></div><div class="objectives" id="objectives"></div><script>function color(p){return p>=70?'#22c55e':p>=40?'#f59e0b':'#ef4444';}function render(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const oi=h.findIndex(x=>x.includes('objective'));const ki=h.findIndex(x=>x.includes('key result')||x.includes('kr'));const pi=h.findIndex(x=>x.includes('progress')||x.includes('percent'));const wi=h.findIndex(x=>x.includes('owner'));const rows=lines.slice(1).map(l=>{const c=l.split(',').map(s=>s.trim());return{obj:c[oi>=0?oi:0],kr:c[ki>=0?ki:1],progress:parseFloat(c[pi>=0?pi:2])||0,owner:c[wi>=0?wi:3]||''};});const grouped={};rows.forEach(r=>{if(!grouped[r.obj])grouped[r.obj]=[];grouped[r.obj].push(r);});const objs=Object.entries(grouped);const totalKRs=rows.length;const avgProgress=rows.length?Math.round(rows.reduce((s,r)=>s+r.progress,0)/rows.length):0;document.getElementById('summary').innerHTML=`<div class="sum-card"><div class="num">${objs.length}</div><div class="label">Objectives</div></div><div class="sum-card"><div class="num">${totalKRs}</div><div class="label">Key Results</div></div><div class="sum-card"><div class="num" style="color:${color(avgProgress)}">${avgProgress}%</div><div class="label">Avg Progress</div></div>`;const el=document.getElementById('objectives');objs.forEach(([obj,krs])=>{const avg=Math.round(krs.reduce((s,k)=>s+k.progress,0)/krs.length);const c=color(avg);el.innerHTML+=`<div class="obj"><div class="obj-header"><span class="title">${obj}</span><span class="pct" style="background:${c}20;color:${c}">${avg}%</span></div><div class="bar-track"><div class="bar-fill" style="width:${avg}%;background:${c}"></div></div>${krs.map(k=>{const kc=color(k.progress);return`<div class="kr"><div class="kr-info"><div class="kr-name">${k.kr}</div>${k.owner?`<div class="kr-owner">${k.owner}</div>`:''}</div><div class="kr-bar"><div style="height:4px;background:#f1f5f9;border-radius:2px"><div style="height:100%;width:${k.progress}%;background:${kc};border-radius:2px"></div></div></div><div class="kr-pct" style="color:${kc}">${k.progress}%</div></div>`;}).join('')}</div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Objective, Key Result, Progress columns.</p>';</script></body></html>'''

_INVOICE_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}@media print{body{padding:0;background:white}}.invoice{max-width:700px;margin:0 auto;background:white;border-radius:12px;border:1px solid #e2e8f0;padding:40px}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px}.header h1{font-size:28px;color:#1e293b;letter-spacing:2px}.header .meta{text-align:right;font-size:13px;color:#64748b}.header .meta div{margin-bottom:4px}.header .inv-num{font-size:15px;font-weight:600;color:#1e293b}table{width:100%;border-collapse:collapse;margin:24px 0}th{background:#f8fafc;padding:10px 12px;text-align:left;font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid #e2e8f0}td{padding:10px 12px;font-size:13px;color:#334155;border-bottom:1px solid #f1f5f9}td.right,th.right{text-align:right}.totals{margin-left:auto;width:250px}.totals .row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;color:#475569}.totals .row.grand{border-top:2px solid #1e293b;margin-top:8px;padding-top:10px;font-size:16px;font-weight:700;color:#1e293b}.footer{margin-top:32px;padding-top:16px;border-top:1px solid #e2e8f0;font-size:12px;color:#94a3b8;text-align:center}</style></head><body><div class="invoice"><div class="header"><div><h1>INVOICE</h1><div style="font-size:13px;color:#64748b;margin-top:4px">Your Company Name<br>123 Business St<br>City, State 12345</div></div><div class="meta"><div class="inv-num">INV-${new Date().getFullYear()}${String(new Date().getMonth()+1).padStart(2,'0')}001</div><div>Date: ${new Date().toLocaleDateString()}</div><div>Due: Net 30</div></div></div><table><thead><tr><th>Item</th><th>Description</th><th class="right">Qty</th><th class="right">Unit Price</th><th class="right">Tax</th><th class="right">Amount</th></tr></thead><tbody id="items"></tbody></table><div class="totals" id="totals"></div><div class="footer">Thank you for your business! Payment is due within 30 days.</div></div><script>function render(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const ii=h.findIndex(x=>x.includes('item')||x.includes('name'));const di=h.findIndex(x=>x.includes('desc'));const qi=h.findIndex(x=>x.includes('qty')||x.includes('quantity'));const pi=h.findIndex(x=>x.includes('price')||x.includes('rate'));const ti=h.findIndex(x=>x.includes('tax'));let subtotal=0,totalTax=0;const tbody=document.getElementById('items');lines.slice(1).forEach(l=>{const c=l.split(',').map(s=>s.trim());const item=c[ii>=0?ii:0];const desc=di>=0?c[di]:'';const qty=parseFloat(c[qi>=0?qi:2])||1;const price=parseFloat(c[pi>=0?pi:3])||0;const taxRate=parseFloat(c[ti>=0?ti:4])||0;const lineTotal=qty*price;const lineTax=lineTotal*taxRate/100;subtotal+=lineTotal;totalTax+=lineTax;tbody.innerHTML+=`<tr><td>${item}</td><td>${desc}</td><td class="right">${qty}</td><td class="right">$${price.toFixed(2)}</td><td class="right">${taxRate}%</td><td class="right">$${lineTotal.toFixed(2)}</td></tr>`;});const grand=subtotal+totalTax;document.getElementById('totals').innerHTML=`<div class="row"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div><div class="row"><span>Tax</span><span>$${totalTax.toFixed(2)}</span></div><div class="row grand"><span>Total</span><span>$${grand.toFixed(2)}</span></div>`;}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Item, Quantity, Unit Price, Tax Rate columns.</p>';</script></body></html>'''

_HABIT_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:8px;font-size:20px}.summary{display:flex;gap:12px;justify-content:center;margin-bottom:20px;flex-wrap:wrap}.sum-card{background:white;padding:12px 20px;border-radius:10px;border:1px solid #e2e8f0;text-align:center}.sum-card .num{font-size:22px;font-weight:700;color:#1e293b}.sum-card .label{font-size:11px;color:#94a3b8}.grid{max-width:800px;margin:0 auto;background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}table{width:100%;border-collapse:collapse}th{background:#f8fafc;padding:10px 12px;font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;border-bottom:2px solid #e2e8f0}td{padding:8px 12px;text-align:center;border-bottom:1px solid #f8fafc;font-size:13px}.habit-name{text-align:left;font-weight:600;color:#1e293b}.done{background:#dcfce7;color:#16a34a;border-radius:6px}.missed{background:#f8fafc;color:#cbd5e1;border-radius:6px}.streak{font-weight:600;color:#f59e0b}.pct{font-weight:600}</style></head><body><h1>Habit Tracker</h1><div class="summary" id="summary"></div><div class="grid"><table id="table"></table></div><script>function isDone(v){return['yes','1','true','x','done','✓','✔'].includes((v||'').toLowerCase().trim());}function render(csv){const lines=csv.trim().split('\\n');const headers=lines[0].split(',').map(h=>h.trim());const days=headers.slice(1);const habits=[];lines.slice(1).forEach(l=>{const c=l.split(',').map(s=>s.trim());const name=c[0];const vals=c.slice(1).map(isDone);const completed=vals.filter(Boolean).length;let streak=0,maxStreak=0,cur=0;vals.forEach(v=>{if(v){cur++;maxStreak=Math.max(maxStreak,cur);}else cur=0;});streak=maxStreak;const pct=vals.length?Math.round(completed/vals.length*100):0;habits.push({name,vals,completed,streak,pct});});const totalDone=habits.reduce((s,h)=>s+h.completed,0);const totalCells=habits.reduce((s,h)=>s+h.vals.length,0);const overallPct=totalCells?Math.round(totalDone/totalCells*100):0;document.getElementById('summary').innerHTML=`<div class="sum-card"><div class="num">${habits.length}</div><div class="label">Habits</div></div><div class="sum-card"><div class="num">${totalDone}</div><div class="label">Completed</div></div><div class="sum-card"><div class="num" style="color:${overallPct>=70?'#22c55e':overallPct>=40?'#f59e0b':'#ef4444'}">${overallPct}%</div><div class="label">Overall</div></div>`;const t=document.getElementById('table');t.innerHTML=`<tr><th>Habit</th>${days.map(d=>`<th>${d}</th>`).join('')}<th>Streak</th><th>Done</th></tr>`+habits.map(h=>`<tr><td class="habit-name">${h.name}</td>${h.vals.map(v=>`<td class="${v?'done':'missed'}">${v?'✓':'·'}</td>`).join('')}<td class="streak">${h.streak>0?'🔥'+h.streak:'—'}</td><td class="pct" style="color:${h.pct>=70?'#22c55e':h.pct>=40?'#f59e0b':'#ef4444'}">${h.pct}%</td></tr>`).join('');}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Habit name and day columns (yes/no values).</p>';</script></body></html>'''

_KPI_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:20px;font-size:20px}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px;max-width:1000px;margin:0 auto}.card{background:white;border-radius:12px;padding:20px;border:1px solid #e2e8f0}.card .label{font-size:12px;color:#64748b;font-weight:500;margin-bottom:4px}.card .value{font-size:28px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:8px}.card .arrow{font-size:14px;padding:2px 6px;border-radius:6px;font-weight:600}.card .up{background:#dcfce7;color:#16a34a}.card .down{background:#fee2e2;color:#ef4444}.card .target-bar{height:6px;background:#f1f5f9;border-radius:3px;margin-top:12px;overflow:hidden}.card .target-fill{height:100%;border-radius:3px}.card .target-text{font-size:11px;color:#94a3b8;margin-top:4px;display:flex;justify-content:space-between}.card .cat{font-size:10px;color:#94a3b8;margin-top:8px;text-transform:uppercase;letter-spacing:0.5px}</style></head><body><h1>KPI Dashboard</h1><div class="grid" id="grid"></div><script>function render(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const mi=h.findIndex(x=>x.includes('metric')||x.includes('kpi')||x.includes('name'));const ci=h.findIndex(x=>x.includes('current')||x.includes('actual')||x.includes('value'));const ti=h.findIndex(x=>x.includes('target')||x.includes('goal'));const pi=h.findIndex(x=>x.includes('previous')||x.includes('last'));const ui=h.findIndex(x=>x.includes('unit'));const cati=h.findIndex(x=>x.includes('category')||x.includes('group'));const el=document.getElementById('grid');lines.slice(1).forEach(l=>{const c=l.split(',').map(s=>s.trim());const metric=c[mi>=0?mi:0];const current=parseFloat(c[ci>=0?ci:1])||0;const target=ti>=0?parseFloat(c[ti]):null;const prev=pi>=0?parseFloat(c[pi]):null;const unit=ui>=0?c[ui]:'';const cat=cati>=0?c[cati]:'';const pct=target?Math.min(100,Math.round(current/target*100)):null;const changed=prev!==null&&!isNaN(prev);const up=changed&&current>=prev;const diff=changed?((current-prev)/prev*100).toFixed(1):null;const barColor=pct>=100?'#22c55e':pct>=70?'#3b82f6':pct>=40?'#f59e0b':'#ef4444';el.innerHTML+=`<div class="card"><div class="label">${metric}</div><div class="value">${unit==='%'?current+'%':unit==='$'?'$'+current.toLocaleString():current.toLocaleString()}${changed?`<span class="arrow ${up?'up':'down'}">${up?'↑':'↓'}${Math.abs(diff)}%</span>`:''}</div>${pct!==null?`<div class="target-bar"><div class="target-fill" style="width:${pct}%;background:${barColor}"></div></div><div class="target-text"><span>Current: ${current}</span><span>Target: ${target}</span></div>`:''} ${cat?`<div class="cat">${cat}</div>`:''}</div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Metric, Current, Target, Previous columns.</p>';</script></body></html>'''

_ROADMAP_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:4px;font-size:20px}.controls{text-align:center;margin-bottom:16px}select{padding:6px 12px;border:1px solid #e2e8f0;border-radius:8px;font-size:13px;color:#334155;margin:0 4px}.swimlanes{max-width:900px;margin:0 auto}.lane{margin-bottom:20px;background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}.lane-header{padding:14px 20px;font-size:15px;font-weight:600;color:#1e293b;background:#f8fafc;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}.lane-header .count{font-size:12px;color:#94a3b8;font-weight:400}.lane-body{padding:12px;display:flex;flex-wrap:wrap;gap:10px}.feature{padding:12px 16px;border-radius:8px;border:1px solid #e2e8f0;flex:1;min-width:200px;max-width:280px}.feature .name{font-size:13px;font-weight:600;color:#1e293b;margin-bottom:6px}.feature .desc{font-size:11px;color:#64748b;margin-bottom:8px}.feature .tags{display:flex;gap:6px;flex-wrap:wrap}.tag{font-size:10px;padding:2px 8px;border-radius:10px;font-weight:500}.status-planned{background:#dbeafe;color:#2563eb}.status-progress{background:#fef3c7;color:#d97706}.status-shipped{background:#dcfce7;color:#16a34a}.team-tag{background:#f1f5f9;color:#475569}</style></head><body><h1>Product Roadmap</h1><div class="controls"><select id="teamFilter" onchange="rerender()"><option value="">All Teams</option></select></div><div class="swimlanes" id="lanes"></div><script>let ALL_ROWS=[];function parse(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const fi=h.findIndex(x=>x.includes('feature')||x.includes('name')||x.includes('title'));const qi=h.findIndex(x=>x.includes('quarter')||x.includes('period')||x.includes('milestone'));const si=h.findIndex(x=>x.includes('status'));const pi=h.findIndex(x=>x.includes('priority'));const ti=h.findIndex(x=>x.includes('team'));const di=h.findIndex(x=>x.includes('desc'));ALL_ROWS=lines.slice(1).map(l=>{const c=l.split(',').map(s=>s.trim());return{feature:c[fi>=0?fi:0],quarter:c[qi>=0?qi:1]||'Unplanned',status:(c[si>=0?si:2]||'planned').toLowerCase(),priority:c[pi>=0?pi:3]||'',team:c[ti>=0?ti:4]||'',desc:c[di>=0?di:5]||''};});const teams=[...new Set(ALL_ROWS.map(r=>r.team).filter(Boolean))];const sel=document.getElementById('teamFilter');teams.forEach(t=>{sel.innerHTML+=`<option value="${t}">${t}</option>`;});}function rerender(){const filter=document.getElementById('teamFilter').value;const rows=filter?ALL_ROWS.filter(r=>r.team===filter):ALL_ROWS;const quarters=[...new Set(rows.map(r=>r.quarter))];const el=document.getElementById('lanes');el.innerHTML='';quarters.forEach(q=>{const items=rows.filter(r=>r.quarter===q);const statusClass=s=>s.includes('progress')?'status-progress':s.includes('ship')||s.includes('done')||s.includes('complete')?'status-shipped':'status-planned';el.innerHTML+=`<div class="lane"><div class="lane-header">${q}<span class="count">${items.length} items</span></div><div class="lane-body">${items.map(r=>`<div class="feature"><div class="name">${r.feature}</div>${r.desc?`<div class="desc">${r.desc}</div>`:''}<div class="tags"><span class="tag ${statusClass(r.status)}">${r.status}</span>${r.team?`<span class="tag team-tag">${r.team}</span>`:''}</div></div>`).join('')}</div></div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data){parse(data);rerender();}else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Feature, Quarter, Status, Team columns.</p>';</script></body></html>'''

_RETRO_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:20px;font-size:20px}.board{display:flex;gap:16px;max-width:1000px;margin:0 auto;overflow-x:auto}.column{flex:1;min-width:250px;border-radius:12px;overflow:hidden}.col-header{padding:14px 16px;font-weight:600;font-size:14px;color:white;display:flex;justify-content:space-between;align-items:center}.col-header .count{opacity:0.7;font-size:12px}.col-body{padding:8px;min-height:200px}.note{padding:14px;margin-bottom:8px;border-radius:8px;background:white;box-shadow:0 1px 3px rgba(0,0,0,0.08)}.note .text{font-size:13px;color:#334155;line-height:1.5}.note .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-size:11px;color:#94a3b8}.note .votes{font-weight:600;display:flex;align-items:center;gap:4px}.good{background:#dcfce7}.good .col-header{background:#16a34a}.improve{background:#fef3c7}.improve .col-header{background:#d97706}.action{background:#dbeafe}.action .col-header{background:#2563eb}</style></head><body><h1>Retrospective Board</h1><div class="board" id="board"></div><script>const CAT_MAP={'what went well':'good','went well':'good','keep doing':'good','good':'good','positive':'good','what to improve':'improve','improve':'improve','improvement':'improve','needs work':'improve','stop doing':'improve','action items':'action','actions':'action','action':'action','try':'action','start doing':'action'};function render(csv){const lines=csv.trim().split('\\n');const h=lines[0].split(',').map(s=>s.trim().toLowerCase());const ci=h.findIndex(x=>x.includes('category')||x.includes('type'));const ii=h.findIndex(x=>x.includes('item')||x.includes('text')||x.includes('comment'));const ai=h.findIndex(x=>x.includes('author')||x.includes('name'));const vi=h.findIndex(x=>x.includes('vote'));const groups={good:[],improve:[],action:[]};lines.slice(1).forEach(l=>{const c=l.split(',').map(s=>s.trim());const cat=(c[ci>=0?ci:0]||'').toLowerCase();const mapped=CAT_MAP[cat]||'good';groups[mapped].push({text:c[ii>=0?ii:1],author:c[ai>=0?ai:2]||'',votes:parseInt(c[vi>=0?vi:3])||0});});Object.values(groups).forEach(g=>g.sort((a,b)=>b.votes-a.votes));const el=document.getElementById('board');const sections=[{key:'good',title:'What Went Well',cls:'good'},{key:'improve',title:'What To Improve',cls:'improve'},{key:'action',title:'Action Items',cls:'action'}];sections.forEach(s=>{const items=groups[s.key];el.innerHTML+=`<div class="column ${s.cls}"><div class="col-header">${s.title}<span class="count">${items.length}</span></div><div class="col-body">${items.map(i=>`<div class="note"><div class="text">${i.text}</div><div class="meta"><span>${i.author}</span><span class="votes">👍 ${i.votes}</span></div></div>`).join('')}</div></div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with Category, Item, Author, Votes columns.</p>';</script></body></html>'''

_LINE_CHART_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:20px;font-size:20px}.chart-container{max-width:800px;margin:0 auto;background:white;border-radius:12px;border:1px solid #e2e8f0;padding:24px}.legend{display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-top:16px}.legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:#475569}.swatch{width:12px;height:3px;border-radius:2px}</style></head><body><h1>Trend Chart</h1><div class="chart-container"><svg id="chart" width="100%" viewBox="0 0 700 350"></svg><div class="legend" id="legend"></div></div><script>const COLORS=['#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#14b8a6'];function render(csv){const lines=csv.trim().split('\\n');const headers=lines[0].split(',').map(h=>h.trim());const labels=[];const series={};headers.slice(1).forEach(h=>{series[h]=[];});lines.slice(1).forEach(l=>{const c=l.split(',').map(s=>s.trim());labels.push(c[0]);headers.slice(1).forEach((h,i)=>{series[h].push(parseFloat(c[i+1])||0);});});const allVals=Object.values(series).flat();const minV=Math.min(...allVals);const maxV=Math.max(...allVals);const range=maxV-minV||1;const pad={t:20,r:20,b:40,l:50};const W=700-pad.l-pad.r;const H=350-pad.t-pad.b;const svg=document.getElementById('chart');let html=`<g transform="translate(${pad.l},${pad.t})">`;const yTicks=5;for(let i=0;i<=yTicks;i++){const y=H-(i/yTicks)*H;const val=(minV+(i/yTicks)*range).toFixed(0);html+=`<line x1="0" y1="${y}" x2="${W}" y2="${y}" stroke="#f1f5f9" stroke-width="1"/>`;html+=`<text x="-8" y="${y+4}" text-anchor="end" fill="#94a3b8" font-size="11">${val}</text>`;}labels.forEach((l,i)=>{const x=(i/(labels.length-1||1))*W;if(i%(Math.ceil(labels.length/8))===0||i===labels.length-1){html+=`<text x="${x}" y="${H+24}" text-anchor="middle" fill="#94a3b8" font-size="11">${l}</text>`;}});const seriesNames=Object.keys(series);seriesNames.forEach((name,si)=>{const vals=series[name];const color=COLORS[si%COLORS.length];const points=vals.map((v,i)=>{const x=(i/(vals.length-1||1))*W;const y=H-((v-minV)/range)*H;return`${x},${y}`;});html+=`<polyline points="${points.join(' ')}" fill="none" stroke="${color}" stroke-width="2.5" stroke-linejoin="round"/>`;vals.forEach((v,i)=>{const x=(i/(vals.length-1||1))*W;const y=H-((v-minV)/range)*H;html+=`<circle cx="${x}" cy="${y}" r="3.5" fill="${color}" stroke="white" stroke-width="1.5"><title>${name}: ${v}</title></circle>`;});});html+=`</g>`;svg.innerHTML=html;const legend=document.getElementById('legend');seriesNames.forEach((name,i)=>{legend.innerHTML+=`<div class="legend-item"><div class="swatch" style="background:${COLORS[i%COLORS.length]}"></div>${name}</div>`;});}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data. Use a CSV with first column as labels and numeric columns as data series.</p>';</script></body></html>'''

_FORM_VIEW_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:20px;font-size:20px}.card{max-width:600px;margin:0 auto;background:white;border-radius:12px;border:1px solid #e2e8f0;overflow:hidden}.nav{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:#f8fafc;border-bottom:1px solid #e2e8f0}.nav button{padding:8px 16px;border:1px solid #e2e8f0;border-radius:8px;background:white;font-size:13px;color:#475569;cursor:pointer}.nav button:hover{background:#f1f5f9}.nav button:disabled{opacity:0.3;cursor:default}.nav .counter{font-size:13px;color:#64748b;font-weight:500}.fields{padding:20px}.field{margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #f8fafc}.field:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}.field .label{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:4px}.field .value{font-size:15px;color:#1e293b}.field .value.num{color:#2563eb;font-weight:600}</style></head><body><h1>Record View</h1><div class="card"><div class="nav"><button id="prev" onclick="go(-1)">← Previous</button><span class="counter" id="counter"></span><button id="next" onclick="go(1)">Next →</button></div><div class="fields" id="fields"></div></div><script>let HEADERS=[],ROWS=[],current=0;function render(){const row=ROWS[current];const el=document.getElementById('fields');el.innerHTML=HEADERS.map((h,i)=>{const v=row[i]||'—';const isNum=!isNaN(parseFloat(v))&&v.trim()!=='';return`<div class="field"><div class="label">${h}</div><div class="value${isNum?' num':''}">${v}</div></div>`;}).join('');document.getElementById('counter').textContent=`${current+1} of ${ROWS.length}`;document.getElementById('prev').disabled=current===0;document.getElementById('next').disabled=current===ROWS.length-1;}function go(d){current=Math.max(0,Math.min(ROWS.length-1,current+d));render();}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data){const lines=data.trim().split('\\n');HEADERS=lines[0].split(',').map(h=>h.trim());ROWS=lines.slice(1).map(l=>l.split(',').map(c=>c.trim()));render();}else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data.</p>';</script></body></html>'''

_COMPARISON_HTML = '''<!DOCTYPE html><html><head><meta charset="utf-8"><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;padding:20px;background:#f8fafc}h1{text-align:center;color:#1e293b;margin-bottom:20px;font-size:20px}.table-wrap{max-width:900px;margin:0 auto;overflow-x:auto;background:white;border-radius:12px;border:1px solid #e2e8f0}table{width:100%;border-collapse:collapse;font-size:13px}th{padding:12px 16px;text-align:left;font-weight:600;color:#1e293b;background:#f8fafc;border-bottom:2px solid #e2e8f0;position:sticky;top:0}th:first-child{min-width:180px}td{padding:10px 16px;border-bottom:1px solid #f1f5f9;color:#334155}td:first-child{font-weight:600;color:#1e293b;background:#f8fafc;border-right:1px solid #e2e8f0}.yes{color:#16a34a;font-weight:600}.no{color:#ef4444;font-weight:600}.highlight{background:#f0fdf4}.negative{background:#fef2f2}tr:hover td{background:#f8fafc}tr:hover td:first-child{background:#f1f5f9}</style></head><body><h1>Comparison Table</h1><div class="table-wrap"><table id="table"></table></div><script>function render(csv){const lines=csv.trim().split('\\n');const headers=lines[0].split(',').map(h=>h.trim());const rows=lines.slice(1).map(l=>l.split(',').map(c=>c.trim()));const el=document.getElementById('table');const positive=['yes','true','✓','✔','included','unlimited','all plans'];const negative=['no','false','✗','✘','none','limited'];el.innerHTML=`<tr>${headers.map(h=>`<th>${h}</th>`).join('')}</tr>`+rows.map(r=>`<tr>${r.map((c,i)=>{const cl=c.toLowerCase();const isPos=positive.includes(cl);const isNeg=negative.includes(cl);const cls=i===0?'':(isPos?' class="yes highlight"':isNeg?' class="no negative"':'');return`<td${cls}>${isPos?'✓ '+c:isNeg?'✗ '+c:c}</td>`;}).join('')}</tr>`).join('');}const data=document.body.getAttribute('data-csv')||window.__SOURCE_CSV__||'';if(data)render(data);else document.body.innerHTML='<p style="text-align:center;color:#94a3b8;padding:40px">No data.</p>';</script></body></html>'''

APP_TEMPLATES = [
    _app("app-crm", "CRM Pipeline", "users", "business", _CRM_HTML, 20, "Kanban-style CRM pipeline view for contacts and deals"),
    _app("app-sprint-board", "Sprint Board", "kanban", "project", _SPRINT_BOARD_HTML, 21, "Agile sprint board with status columns and priority badges"),
    _app("app-okr-tracker", "OKR Tracker", "target", "project", _OKR_HTML, 22, "Track objectives and key results with progress bars"),
    _app("app-invoice-gen", "Invoice Generator", "receipt", "business", _INVOICE_HTML, 23, "Professional invoice layout with auto-calculated totals"),
    _app("app-habit-tracker", "Habit Tracker", "check-square", "personal", _HABIT_HTML, 24, "Track daily habits with streaks and completion rates"),
    _app("app-kpi-dashboard", "KPI Dashboard", "gauge", "business", _KPI_HTML, 25, "Big-number KPI cards with targets and trend indicators"),
    _app("app-roadmap", "Product Roadmap", "map", "project", _ROADMAP_HTML, 26, "Swimlane product roadmap by quarter with team filters"),
    _app("app-retro-board", "Retro Board", "message-square", "project", _RETRO_HTML, 27, "Retrospective board with good/improve/action columns"),
    _app("app-line-chart", "Line Chart", "trending-up", "visualization", _LINE_CHART_HTML, 28, "Multi-series line/trend chart for time-series data"),
    _app("app-form-view", "Record View", "file-text", "display", _FORM_VIEW_HTML, 29, "View one CSV row at a time as a detailed record card"),
    _app("app-comparison", "Comparison Table", "columns", "display", _COMPARISON_HTML, 30, "Side-by-side feature comparison with visual indicators"),
]


# ── SLUGS for downgrade ──────────────────────────────────────────────────────

ALL_SLUGS = (
    [c["slug"] for c in COMMANDS]
    + [f["slug"] for f in FILE_TEMPLATES]
    + [f["slug"] for f in FOLDER_TEMPLATES]
    + [a["slug"] for a in APP_TEMPLATES]
)


def upgrade() -> None:
    marketplace_items = sa.table(
        "marketplace_items",
        sa.column("id", postgresql.UUID),
        sa.column("item_type", sa.String),
        sa.column("slug", sa.String),
        sa.column("name", sa.String),
        sa.column("description", sa.Text),
        sa.column("icon", sa.String),
        sa.column("category", sa.String),
        sa.column("content", sa.Text),
        sa.column("is_builtin", sa.Boolean),
        sa.column("is_featured", sa.Boolean),
        sa.column("install_count", sa.Integer),
        sa.column("sort_order", sa.Integer),
    )

    all_items = COMMANDS + FILE_TEMPLATES + FOLDER_TEMPLATES + APP_TEMPLATES
    op.bulk_insert(marketplace_items, all_items)


def downgrade() -> None:
    op.execute(
        sa.text(
            "DELETE FROM marketplace_items WHERE slug = ANY(:slugs)"
        ).bindparams(slugs=ALL_SLUGS)
    )
